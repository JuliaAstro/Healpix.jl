import Healpix
using Test

## spin 0 map2alm
nside = 4
lmax = 4
map = Healpix.Map{Float64, Healpix.RingOrder}(2 .* ones(Healpix.nside2npix(nside)))
alm = Healpix.map2alm(map, lmax, lmax)

test_alm_spin0 = [
    7.08981540e+00,  6.26606889e-17, -4.64452418e-02, -1.43573675e-16,
    -1.10275269e-01,  0.00000000e+00, 0.00000000e+00,  0.00000000e+00,
    0.00000000e+00,  0.00000000e+00, 0.00000000e+00,  0.00000000e+00,
    0.00000000e+00,  0.00000000e+00, -7.87873039e-04-9.64866195e-20im]
@test isapprox(alm.alm , test_alm_spin0)

## spin 0 alm2map
nside = 2
lmax = 2
nalms = Healpix.numberOfAlms(lmax, lmax)
alm = Healpix.Alm{ComplexF64}(lmax, lmax, 2 .* ones(ComplexF64, nalms))
map = Healpix.alm2map(alm, nside)

test_map_spin0 = [
        1.22822792,  3.61032581,  3.61032581,  1.22822792, -0.33740788,
       -0.16286106,  1.80075965,  4.40319186,  4.40319186,  1.80075965,
       -0.16286106, -0.33740788, -0.4312723 , -1.13862492, -0.90401688,
        2.07742993,  4.11691608,  2.07742993, -0.90401688, -1.13862492,
       -0.25082501, -1.68800153, -0.63028243,  2.30273478,  2.30273478,
       -0.63028243, -1.68800153, -0.25082501,  0.859566  , -0.41667555,
       -1.5554869 ,  0.05254053,  1.52313774,  0.05254053, -1.5554869 ,
       -0.41667555,  1.19694074, -0.29055765, -0.67742383,  0.26296318,
        0.26296318, -0.67742383, -0.29055765,  1.19694074,  1.03769816,
        0.21777049,  0.21777049,  1.03769816]
@test isapprox(map.pixels, test_map_spin0)

## spin 2 map2alm
nside = 4
lmax = 4
map = Healpix.PolarizedMap{Float64, Healpix.RingOrder}(
    2 .* ones(Healpix.nside2npix(nside)),
    2 .* ones(Healpix.nside2npix(nside)),
    2 .* ones(Healpix.nside2npix(nside)))
alms = Healpix.map2alm(map, lmax, lmax)
test_alm_spin2 = [ 
    0.00000000e+00,  0.00000000e+00,
    -6.49104757e+00, -1.31064234e-16,
    -2.27889895e+00,  0.00000000e+00,
    0.00000000e+00,  0.00000000e+00,
    0.00000000e+00,  0.00000000e+00,
    0.00000000e+00,  0.00000000e+00,
    0.00000000e+00,  0.00000000e+00,
    2.36716190e-02+2.89893725e-18im]
@test isapprox(alms[1].alm, test_alm_spin0)
@test isapprox(alms[2].alm, test_alm_spin2)
@test isapprox(alms[3].alm, test_alm_spin2)

## spin 2 alm2map
nside = 2
lmax = 2
nalms = Healpix.numberOfAlms(lmax, lmax)
alm_t = Healpix.Alm{ComplexF64}(lmax, lmax, 2 .* ones(ComplexF64, nalms))
alm_e = Healpix.Alm{ComplexF64}(lmax, lmax, 2 .* ones(ComplexF64, nalms))
alm_b = Healpix.Alm{ComplexF64}(lmax, lmax, 2 .* ones(ComplexF64, nalms))

maps = Healpix.alm2map([alm_t, alm_e, alm_b], nside)

@test isapprox(maps.i , test_map_spin0)

test_map_spin2_q = [
    -1.9631492 ,  1.00333301, -0.59650858,  1.06275217, -2.6071711 ,
    -1.4882688 ,  0.1809384 , -0.25943678, -0.72916617,  0.72899969,
    1.43862464, -0.69806834, -1.78405186, -2.22862401, -1.17525562,
    -0.82688372, -0.99110781,  0.01416045,  1.20357653,  0.29450851,
    -1.70135994, -1.49205262, -1.49205262, -1.70135994, -0.73579893,
    0.83901787,  0.83901787, -0.73579893, -0.99110781, -0.82688372,
    -1.17525562, -2.22862401, -1.78405186,  0.29450851,  1.20357653,
    0.01416045, -0.25943678,  0.1809384 , -1.4882688 , -2.6071711 ,
    -0.69806834,  1.43862464,  0.72899969, -0.72916617,  1.00333301,
    -1.9631492 ,  1.06275217, -0.59650858]
@test isapprox(maps.q , test_map_spin2_q)

test_map_spin2_u = [ 
    1.06275217, -0.59650858,  1.00333301, -1.9631492 , -0.69806834,
     1.43862464,  0.72899969, -0.72916617, -0.25943678,  0.1809384 ,
    -1.4882688 , -2.6071711 , -1.78405186,  0.29450851,  1.20357653,
     0.01416045, -0.99110781, -0.82688372, -1.17525562, -2.22862401,
    -0.73579893,  0.83901787,  0.83901787, -0.73579893, -1.70135994,
    -1.49205262, -1.49205262, -1.70135994, -0.99110781,  0.01416045,
     1.20357653,  0.29450851, -1.78405186, -2.22862401, -1.17525562,
    -0.82688372, -0.72916617,  0.72899969,  1.43862464, -0.69806834,
    -2.6071711 , -1.4882688 ,  0.1809384 , -0.25943678, -0.59650858,
     1.06275217, -1.9631492 ,  1.00333301]
@test isapprox(maps.u , test_map_spin2_u)
